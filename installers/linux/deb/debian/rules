#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

%:
	dh $@

override_dh_auto_build:
	scons --platform=linux --build-config=release linux-all

override_dh_auto_install:
	# Install library
	install -D -m 755 build/linux-x64-release/liblaprdus.so \
		debian/laprdus/usr/lib/$(DEB_HOST_MULTIARCH)/liblaprdus.so.1.0.0
	ln -s liblaprdus.so.1.0.0 \
		debian/laprdus/usr/lib/$(DEB_HOST_MULTIARCH)/liblaprdus.so.1
	ln -s liblaprdus.so.1 \
		debian/laprdus/usr/lib/$(DEB_HOST_MULTIARCH)/liblaprdus.so

	# Install CLI
	install -D -m 755 build/linux-x64-release/laprdus \
		debian/laprdus/usr/bin/laprdus

	# Install voice data
	install -D -m 644 build/linux-x64-release/Josip.bin \
		debian/laprdus/usr/share/laprdus/Josip.bin
	install -D -m 644 build/linux-x64-release/Vlado.bin \
		debian/laprdus/usr/share/laprdus/Vlado.bin

	# Install dictionaries
	install -D -m 644 data/dictionary/internal.json \
		debian/laprdus/usr/share/laprdus/internal.json
	install -D -m 644 data/dictionary/spelling.json \
		debian/laprdus/usr/share/laprdus/spelling.json
	install -D -m 644 data/dictionary/emoji.json \
		debian/laprdus/usr/share/laprdus/emoji.json

	# Install Speech Dispatcher module (if built) - into main package
	if [ -f build/linux-x64-release/sd_laprdus ]; then \
		install -D -m 755 build/linux-x64-release/sd_laprdus \
			debian/laprdus/usr/lib/speech-dispatcher-modules/sd_laprdus; \
		install -D -m 644 src/platform/linux/speechd/laprdus.conf \
			debian/laprdus/etc/speech-dispatcher/modules/laprdus.conf; \
	fi

	# Install development files
	install -D -m 644 include/laprdus/laprdus_api.h \
		debian/laprdus-dev/usr/include/laprdus/laprdus_api.h
	install -D -m 644 include/laprdus/types.hpp \
		debian/laprdus-dev/usr/include/laprdus/types.hpp
	install -D -m 644 include/laprdus/laprdus.hpp \
		debian/laprdus-dev/usr/include/laprdus/laprdus.hpp

override_dh_builddeb:
	@if grep -qi microsoft /proc/version 2>/dev/null; then \
		echo "WSL detected: copying package trees to /tmp to fix NTFS permissions..."; \
		for pkgdir in debian/laprdus debian/laprdus-dev; do \
			pkg=$$(basename $$pkgdir); \
			if [ -d "$$pkgdir/DEBIAN" ]; then \
				tmpdir=$$(mktemp -d /tmp/deb-$$pkg-XXXXXX); \
				cp -a "$$pkgdir" "$$tmpdir/$$pkg"; \
				find "$$tmpdir/$$pkg" -type d -exec chmod 0755 {} \;; \
				find "$$tmpdir/$$pkg" -type f -exec chmod 0644 {} \;; \
				for s in postinst postrm preinst prerm; do \
					[ -f "$$tmpdir/$$pkg/DEBIAN/$$s" ] && chmod 0755 "$$tmpdir/$$pkg/DEBIAN/$$s"; \
				done; \
				find "$$tmpdir/$$pkg/usr/bin" -type f -exec chmod 0755 {} \; 2>/dev/null || true; \
				find "$$tmpdir/$$pkg/usr/lib" -type f \( -name "*.so*" -o -name "sd_*" \) -exec chmod 0755 {} \; 2>/dev/null || true; \
				dpkg-deb --root-owner-group --build "$$tmpdir/$$pkg" ..; \
				rm -rf "$$tmpdir"; \
			fi; \
		done; \
	else \
		dh_builddeb; \
	fi

override_dh_auto_clean:
	scons -c
	rm -rf build/

override_dh_auto_test:
	# Skip tests for now
